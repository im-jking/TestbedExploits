import logging
import random
from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSlaveContext, ModbusServerContext
from pymodbus.server.async_io import StartTcpServer

ip = "192.168.100.5"

# logging.basicConfig()
# log = logging.getLogger()
# log.setLevel(logging.DEBUG)

coils = ModbusSequentialDataBlock(1, [False] * 100)
discrete_inputs = ModbusSequentialDataBlock(1, [False] * 10)
holding_registers = ModbusSequentialDataBlock(1, [0] * 10)
input_registers = ModbusSequentialDataBlock(1, [0] * 10)

slave_context = ModbusSlaveContext(
    di = discrete_inputs,
    co = coils,
    hr = holding_registers,
    ir = input_registers
)

#Set registers to random values, except for register 10
tempValues = [random.randint(1,15) for _ in range(10)]
holding_registers.setValues(1, tempValues)

#Set register 10 (the bandwidth limit register) to 20
holding_registers.setValues(10, 20)

server_context = ModbusServerContext(slaves=slave_context, single=True)


#Start the server on port 5502
StartTcpServer(context=server_context,address=(ip,5502))