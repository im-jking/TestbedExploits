import psutil
from pymodbus.client.tcp import ModbusTcpClient
import time

ip = "192.168.100.5"
server = ModbusTcpClient(ip,port="5502")

i = 0
recentSent = []

lastRecv = psutil.net_io_counters().bytes_recv
lastSent = psutil.net_io_counters().bytes_sent
lastTotal = lastSent + lastRecv

while True:
    newRecv = psutil.net_io_counters().bytes_recv
    newSent = psutil.net_io_counters().bytes_sent
    newTotal = newRecv + newSent

    #Calculate difference in network usage, convert to KB
    kbRecv = (newRecv - lastRecv) / 1024
    kbSent = (newSent - lastSent) / 1024
    kbTotal = (newTotal - lastTotal) / 1024

    lastRecv = newRecv
    lastSent = newSent
    lastTotal = newTotal

    print(f"{kbRecv:.2f} KB received, {kbSent:.2f} KB Sent, {kbTotal:.2f} KB Total")

    if(len(recentSent) > i):
        recentSent[i] = kbSent
    else:
        recentSent.append(kbSent)
    i = (i + 1) % 10

    alarmPoint = sum(server.read_holding_registers(address=9,count=1).registers)
    if(sum(recentSent) > alarmPoint):
        server.write_coil(0, True)
        print(f"Alarm triggered! sum of recentSent = {sum(recentSent)}, alarmPoint = {alarmPoint}")

    time.sleep(10)