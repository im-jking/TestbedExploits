import socket
import tqdm
import os

SERVER_HOST = "0.0.0.0"
SERVER_PORT = 5003

BUFFER_SIZE = 4096
SEPARATOR = "<sep>"

s = socket.socket()

s.bind((SERVER_HOST,SERVER_PORT))
s.listen(5)
print(f"[*] Listening as {SERVER_HOST}:{SERVER_PORT}")

#Accept connection if there is any
clientSocket,address = s.accept()
print(f"[+] {address} is connected.")

#Receive file info using client socket
received = clientSocket.recv(BUFFER_SIZE).decode()
filename, filesize = received.split(SEPARATOR)

#Remove absolute path if it exists
filename = os.path.basename(filename)
#Convert to int
filesize = int(filesize)

#Receive file from socket and write to file stream
progress = tqdm.tqdm(range(filesize),f"Receiving {filename}",unit="B",unit_scale=True,unit_divisor=1024)
with open(filename,"wb") as f:
    while True:
        #Read 1024 bytes from socket
        bytesRead = clientSocket.recv(BUFFER_SIZE)
        if not bytesRead:
            #Nothing was received
            break
        #Write bytes we just received to the file
        f.write(bytesRead)
        #Update progress bar
        progress.update(len(bytesRead))

clientSocket.close()
s.close()